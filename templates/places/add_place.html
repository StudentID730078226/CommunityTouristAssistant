{% extends "base.html" %}

{% block title %}Add Place{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">

            <div class="card shadow-sm">
                <div class="card-body p-4 p-md-5">

                    <h2 class="mb-4 text-center">Add a New Place</h2>

                    <p class="text-muted text-center mb-4">
                        Share a place others should know about. All submissions are reviewed before publishing.
                    </p>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <fieldset class="mb-4">
                            <legend class="h5 mb-3">Step 1: Core details</legend>

                            <div class="d-none">
                                {{ form.category }}
                            </div>

                            <div class="mb-3">
                                <label class="form-label" for="id_place_type">Type of place</label>
                                <select id="id_place_type" name="place_type" class="form-select" required>
                                    <option value="">Select a type...</option>
                                    <option value="heritage" {% if request.POST.place_type == "heritage" %}selected{% endif %}>Heritage</option>
                                    <option value="food" {% if request.POST.place_type == "food" %}selected{% endif %}>Food & Drink</option>
                                    <option value="activity" {% if request.POST.place_type == "activity" %}selected{% endif %}>Activity</option>
                                    <option value="beach" {% if request.POST.place_type == "beach" %}selected{% endif %}>Beach / Lake</option>
                                    <option value="other" {% if request.POST.place_type == "other" %}selected{% endif %}>Other (Generic)</option>
                                </select>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="id_name">Place name</label>
                                    {{ form.name }}
                                    {{ form.name.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_estimated_visit_minutes">Suggested visit length (minutes)</label>
                                    {{ form.estimated_visit_minutes }}
                                    {{ form.estimated_visit_minutes.errors }}
                                </div>
                                <div class="col-12">
                                    <label class="form-label" for="id_description">Description</label>
                                    {{ form.description }}
                                    {{ form.description.errors }}
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="mb-4">
                            <legend class="h5 mb-3">Step 2: Contact & location</legend>
                            <p class="text-muted mb-3">Add as much as you can. More detail helps moderation and trust.</p>

                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label" for="id_location_text">Search location</label>
                                    {{ form.location_text }}
                                    <small class="text-muted d-block mt-1">Used for map pinning (postcode or address).</small>
                                    {{ form.location_text.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_address_line_1">Address line 1</label>
                                    {{ form.address_line_1 }}
                                    {{ form.address_line_1.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_address_line_2">Address line 2</label>
                                    {{ form.address_line_2 }}
                                    {{ form.address_line_2.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_town_city">Town / City</label>
                                    {{ form.town_city }}
                                    {{ form.town_city.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_postcode">Postcode</label>
                                    {{ form.postcode }}
                                    {{ form.postcode.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_website_url">Website</label>
                                    {{ form.website_url }}
                                    {{ form.website_url.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_phone_number">Phone</label>
                                    {{ form.phone_number }}
                                    {{ form.phone_number.errors }}
                                </div>
                            </div>
                        </fieldset>

                        <fieldset id="opening-hours-fields" class="mb-4">
                            <legend class="h5 mb-3">Step 3: Opening hours</legend>
                            <p class="text-muted mb-2">Not shown for beaches.</p>
                            <label class="form-label d-block">Open days</label>
                            <div class="d-flex flex-wrap gap-3 mb-3">
                                {{ form.opening_days_list }}
                            </div>
                            {{ form.opening_days_list.errors }}

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="id_opening_time">Opens at</label>
                                    {{ form.opening_time }}
                                    {{ form.opening_time.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_closing_time">Closes at</label>
                                    {{ form.closing_time }}
                                    {{ form.closing_time.errors }}
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="mb-4">
                            <legend class="h5 mb-3">Step 4: Visitor information</legend>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="id_parking_info">Parking</label>
                                    {{ form.parking_info }}
                                    {{ form.parking_info.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_best_time_to_visit">Best time to visit</label>
                                    {{ form.best_time_to_visit }}
                                    {{ form.best_time_to_visit.errors }}
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-2">
                                        {{ form.child_friendly }}
                                        <label class="form-check-label" for="{{ form.child_friendly.id_for_label }}">Child friendly</label>
                                    </div>
                                    {{ form.child_friendly.errors }}
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-2">
                                        {{ form.pet_friendly }}
                                        <label class="form-check-label" for="{{ form.pet_friendly.id_for_label }}">Pet friendly</label>
                                    </div>
                                    {{ form.pet_friendly.errors }}
                                </div>
                                <div class="col-12">
                                    <label class="form-label" for="id_accessibility_info">Accessibility</label>
                                    {{ form.accessibility_info }}
                                    {{ form.accessibility_info.errors }}
                                </div>
                                <div class="col-12">
                                    <label class="form-label" for="id_transport_info">Public transport</label>
                                    {{ form.transport_info }}
                                    {{ form.transport_info.errors }}
                                </div>
                            </div>
                        </fieldset>

                        <fieldset id="heritage-fields" class="mb-4 d-none">
                            <legend class="h5 mb-3">Heritage details</legend>
                            {{ heritage_form.non_field_errors }}
                            {{ heritage_form.as_p }}
                        </fieldset>

                        <fieldset id="food-fields" class="mb-4 d-none">
                            <legend class="h5 mb-3">Food & drink details</legend>
                            {{ food_form.non_field_errors }}
                            {{ food_form.as_p }}
                        </fieldset>

                        <fieldset id="activity-fields" class="mb-4 d-none">
                            <legend class="h5 mb-3">Activity details</legend>
                            {{ activity_form.non_field_errors }}
                            {{ activity_form.as_p }}
                        </fieldset>

                        <fieldset id="beach-fields" class="mb-4 d-none">
                            <legend class="h5 mb-3">Beach details</legend>
                            {{ beach_form.non_field_errors }}
                            {{ beach_form.as_p }}
                        </fieldset>

                        <fieldset class="mb-4">
                            <legend class="h5 mb-3">Images</legend>
                            <label class="form-label" for="id_images">Upload images</label>
                            <input id="id_images" type="file" name="images" multiple accept="image/*" class="form-control" aria-describedby="image-preview-help image-preview-status">
                            <small id="image-preview-help" class="text-muted d-block mt-2">Image previews will appear below before submission.</small>
                            <p id="image-preview-status" class="visually-hidden" aria-live="polite"></p>
                            <div id="image-previews" class="mt-3 row g-2" aria-live="polite"></div>
                        </fieldset>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                Submit Place
                            </button>
                        </div>

                    </form>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const typeSelect = document.getElementById("id_place_type");
    const categoryField = document.getElementById("id_category");
    const openingHoursFields = document.getElementById("opening-hours-fields");
    const imagesInput = document.getElementById("id_images");
    const previewsWrap = document.getElementById("image-previews");
    const previewStatus = document.getElementById("image-preview-status");
    const selectedFiles = new DataTransfer();

    const sections = {
        heritage: document.getElementById("heritage-fields"),
        food: document.getElementById("food-fields"),
        activity: document.getElementById("activity-fields"),
        beach: document.getElementById("beach-fields"),
    };

    function syncCategory() {
        if (!categoryField) return;
        categoryField.value = typeSelect.value || "other";
    }

    function updateSections() {
        const selected = typeSelect.value;
        Object.entries(sections).forEach(([key, section]) => {
            const isActive = key === selected;
            section.classList.toggle("d-none", !isActive);
            section.querySelectorAll("input, select, textarea").forEach((field) => {
                field.disabled = !isActive;
            });
        });

        const hoursEnabled = selected !== "beach";
        if (openingHoursFields) {
            openingHoursFields.classList.toggle("d-none", !hoursEnabled);
            openingHoursFields.querySelectorAll("input, select").forEach((field) => {
                field.disabled = !hoursEnabled;
            });
        }

        syncCategory();
    }

    if (categoryField && sections[categoryField.value] && !typeSelect.value) {
        typeSelect.value = categoryField.value;
    } else if (categoryField && categoryField.value === "other" && !typeSelect.value) {
        typeSelect.value = "other";
    }

    typeSelect.addEventListener("change", updateSections);
    updateSections();

    function renderImagePreviews() {
        if (!imagesInput || !previewsWrap) return;
        previewsWrap.innerHTML = "";

        const files = Array.from(imagesInput.files || []);
        if (files.length === 0) {
            if (previewStatus) previewStatus.textContent = "No images selected.";
            return;
        }

        files.forEach((file) => {
            if (!file.type.startsWith("image/")) return;

            const col = document.createElement("div");
            col.className = "col-4 col-md-3";

            const card = document.createElement("div");
            card.className = "image-preview-card";

            const img = document.createElement("img");
            img.className = "image-preview-thumb";
            img.alt = file.name;
            img.src = URL.createObjectURL(file);
            img.onload = function () {
                URL.revokeObjectURL(img.src);
            };

            card.appendChild(img);
            col.appendChild(card);
            previewsWrap.appendChild(col);
        });

        if (previewStatus) {
            previewStatus.textContent = files.length + " image preview" + (files.length === 1 ? "" : "s") + " shown.";
        }
    }

    if (imagesInput) {
        imagesInput.addEventListener("change", () => {
            const incoming = Array.from(imagesInput.files || []);
            let rejected = 0;

            incoming.forEach((file) => {
                if (!file.type.startsWith("image/")) {
                    rejected += 1;
                    return;
                }
                const alreadySelected = Array.from(selectedFiles.files).some(
                    (existing) =>
                        existing.name === file.name &&
                        existing.size === file.size &&
                        existing.lastModified === file.lastModified
                );
                if (alreadySelected) {
                    return;
                }
                if (selectedFiles.files.length >= 30) {
                    rejected += 1;
                    return;
                }
                selectedFiles.items.add(file);
            });

            imagesInput.files = selectedFiles.files;
            if (previewStatus) {
                if (selectedFiles.files.length >= 30 && rejected > 0) {
                    previewStatus.textContent = "Maximum 30 images allowed. Extra files were not added.";
                } else if (rejected > 0) {
                    previewStatus.textContent = "Some files were skipped because they were not valid images.";
                }
            }
            renderImagePreviews();
        });
    }
});
</script>
{% endblock %}
